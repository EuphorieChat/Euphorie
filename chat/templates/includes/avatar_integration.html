{% comment %}
This file contains the code snippets you should add to your templates to make the animated avatars work.
You will need to:
1. Add the CSS to your head section
2. Modify the avatar rendering code in your templates
3. Load the template tag library
{% endcomment %}

{% comment %}
====================================================
STEP 1: Add this to the <head> section of your HTML
====================================================
{% endcomment %}

<style>
    /* Enhanced animated avatar styles - Compatible with Euphorie's design */

    /* CSS Variables for color references */
    :root {
      /* Tailwind color references - for the avatar colors */
      --red-400: #f87171;
      --red-500: #ef4444;
      --red-600: #dc2626;

      --blue-400: #60a5fa;
      --blue-500: #3b82f6;
      --blue-600: #2563eb;

      --green-400: #4ade80;
      --green-500: #22c55e;
      --green-600: #16a34a;

      --purple-400: #c084fc;
      --purple-500: #a855f7;
      --purple-600: #9333ea;

      --pink-400: #f472b6;
      --pink-500: #ec4899;
      --pink-600: #db2777;

      --yellow-400: #facc15;
      --yellow-500: #eab308;
      --yellow-600: #ca8a04;

      --orange-400: #fb923c;
      --orange-500: #f97316;
      --orange-600: #ea580c;

      --teal-400: #2dd4bf;
      --teal-500: #14b8a6;
      --teal-600: #0d9488;

      --indigo-400: #818cf8;
      --indigo-500: #6366f1;
      --indigo-600: #4f46e5;

      --rose-400: #fb7185;
      --rose-500: #f43f5e;
      --rose-600: #e11d48;

      --amber-400: #fbbf24;
      --amber-500: #f59e0b;
      --amber-600: #d97706;

      --emerald-400: #34d399;
      --emerald-500: #10b981;
      --emerald-600: #059669;

      --sky-400: #38bdf8;
      --sky-500: #0ea5e9;
      --sky-600: #0284c7;

      --violet-400: #a78bfa;
      --violet-500: #8b5cf6;
      --violet-600: #7c3aed;

      --cyan-400: #22d3ee;
      --cyan-500: #06b6d4;
      --cyan-600: #0891b2;
    }

    /* Gradient Avatar */
    .avatar.avatar-gradient {
      background-size: 200% 200% !important;
    }

    .avatar.avatar-gradient.avatar-gradient-slide {
      animation: gradientSlide var(--animation-duration, 5s) infinite linear;
    }

    .avatar.avatar-gradient.avatar-gradient-rotate {
      animation: gradientRotate var(--animation-duration, 5s) infinite linear;
    }

    @keyframes gradientSlide {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes gradientRotate {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 100% 150%;
      }
    }

    /* Pulse Avatar */
    .avatar.avatar-pulse {
      animation: pulse var(--animation-duration, 3s) infinite ease-in-out;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Spinner Avatar */
    .avatar.avatar-spinner::before {
      content: "";
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--spinner-color, white);
      animation: spin var(--animation-duration, 5s) linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* Border Avatar */
    .avatar.avatar-border {
      border: var(--border-width, 2px) solid transparent;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      animation: borderColor var(--animation-duration, 4s) infinite alternate;
    }

    @keyframes borderColor {
      0% {
        border-color: var(--border-color, var(--pink-500));
      }
      33% {
        border-color: var(--purple-500);
      }
      66% {
        border-color: var(--blue-500);
      }
      100% {
        border-color: var(--border-color, var(--pink-500));
      }
    }

    /* Shine Avatar */
    .avatar.avatar-shine {
      position: relative;
      overflow: hidden;
    }

    .avatar.avatar-shine::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -60%;
      width: 20%;
      height: 200%;
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(30deg);
      animation: shine var(--animation-duration, 6s) infinite linear;
    }

    @keyframes shine {
      0% {
        left: -60%;
      }
      100% {
        left: 160%;
      }
    }
    </style>


    {% comment %}
    ====================================================
    STEP 2: Create a templatetags directory and file
    ====================================================

    Create a directory structure:
    your_project/
    └── chat/
        └── templatetags/
            ├── __init__.py
            └── avatar_tags.py

    Put this code in the avatar_tags.py file:
    ====================================================
    from django import template
    import json

    register = template.Library()

    @register.filter
    def parse_avatar_data(profile_picture_data):
        """Parse avatar data from JSON string"""
        try:
            if profile_picture_data:
                return json.loads(profile_picture_data)
            return None
        except (ValueError, TypeError):
            return None

    @register.filter
    def get_avatar_class(avatar_data):
        """Get the CSS class for an avatar based on its data"""
        if not avatar_data or not isinstance(avatar_data, dict):
            return "avatar-pink"  # Default fallback

        avatar_type = avatar_data.get('type')

        if avatar_type == 'gradient':
            return f"avatar-gradient avatar-gradient-{avatar_data.get('animation_type', 'slide')}"
        elif avatar_type == 'pulse':
            return "avatar-pulse"
        elif avatar_type == 'spinner':
            return "avatar-spinner"
        elif avatar_type == 'border':
            return "avatar-border"
        elif avatar_type == 'shine':
            return "avatar-shine"
        else:
            return "avatar-pink"  # Default fallback

    @register.filter
    def get_avatar_style(avatar_data):
        """Get the inline styles for an avatar based on its data"""
        if not avatar_data or not isinstance(avatar_data, dict):
            return ""

        styles = []
        avatar_type = avatar_data.get('type')

        # Animation duration
        if 'animation_duration' in avatar_data:
            styles.append(f"--animation-duration: {avatar_data['animation_duration']}")

        # Specific styles for each type
        if avatar_type == 'gradient':
            if 'colors' in avatar_data and len(avatar_data['colors']) >= 2:
                bg_from = f"var(--{avatar_data['colors'][0]})"
                bg_to = f"var(--{avatar_data['colors'][1]})"
                styles.append(f"background: linear-gradient(135deg, {bg_from}, {bg_to})")

        elif avatar_type == 'pulse':
            if 'background' in avatar_data:
                styles.append(f"background-color: var(--{avatar_data['background']})")

        elif avatar_type == 'spinner':
            if 'background' in avatar_data:
                styles.append(f"background-color: var(--{avatar_data['background']})")
            if 'spinner_color' in avatar_data:
                styles.append(f"--spinner-color: var(--{avatar_data['spinner_color']})")

        elif avatar_type == 'border':
            if 'background' in avatar_data:
                styles.append(f"background-color: var(--{avatar_data['background']})")
            if 'border_color' in avatar_data:
                styles.append(f"--border-color: var(--{avatar_data['border_color']})")
            if 'border_width' in avatar_data:
                styles.append(f"--border-width: {avatar_data['border_width']}")

        elif avatar_type == 'shine':
            if 'background' in avatar_data:
                styles.append(f"background-color: var(--{avatar_data['background']})")

        return "; ".join(styles)
    ====================================================
    {% endcomment %}


    {% comment %}
    ====================================================
    STEP 3: Add this line near the top of your template file
    ====================================================
    {% endcomment %}

    {% load avatar_tags %}


    {% comment %}
    ====================================================
    STEP 4: Find and REPLACE your avatar rendering code
    ====================================================

    Find this code in your template:
    ====================================================
    <!-- Avatar -->
    <div class="avatar avatar-{% if message.user.username == username %}pink{% else %}orange{% endif %} h-8 w-8 flex-shrink-0 text-sm user-avatar">
        {{ message.user.username|slice:":1"|upper }}
    </div>
    ====================================================

    Replace it with this code:
    ====================================================
    {% endcomment %}

    <!-- Avatar -->
    {% with avatar_data=message.user.profile.profile_picture_data|parse_avatar_data %}
        <div class="avatar {{ avatar_data|get_avatar_class }} h-8 w-8 flex-shrink-0 text-sm user-avatar"
             style="{{ avatar_data|get_avatar_style }}">
            {{ avatar_data.initials|default:message.user.username|slice:":1"|upper }}
        </div>
    {% endwith %}

    {% comment %}
    ====================================================
    STEP 5: Find and REPLACE other avatar instances
    ====================================================

    For example, replace the profile header avatar:
    ====================================================
    <div class="avatar avatar-pink h-10 w-10 mr-3">
        {{ username|slice:":1"|upper }}
    </div>
    ====================================================

    with:
    ====================================================
    {% endcomment %}

    {% with avatar_data=user.profile.profile_picture_data|parse_avatar_data %}
        <div class="avatar {{ avatar_data|get_avatar_class }} h-10 w-10 mr-3"
             style="{{ avatar_data|get_avatar_style }}">
            {{ avatar_data.initials|default:username|slice:":1"|upper }}
        </div>
    {% endwith %}

    {% comment %}
    ====================================================
    Also replace the top menu avatar:
    ====================================================
    <div class="avatar avatar-pink h-7 w-7 text-sm mr-2 user-avatar">
        {{ username|slice:":1"|upper }}
    </div>
    ====================================================

    with:
    ====================================================
    {% endcomment %}

    {% with avatar_data=user.profile.profile_picture_data|parse_avatar_data %}
        <div class="avatar {{ avatar_data|get_avatar_class }} h-7 w-7 text-sm mr-2 user-avatar"
             style="{{ avatar_data|get_avatar_style }}">
            {{ avatar_data.initials|default:username|slice:":1"|upper }}
        </div>
    {% endwith %}
