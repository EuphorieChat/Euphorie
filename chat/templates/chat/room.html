<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load chat_extras %}
<head>
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon-16x16.png' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon-180x180.png' %}">
  <meta charset="UTF-8">
  <title>Euphorie - {{ room_name|title }} üí¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Fully remove the WebSocket debug plug (panel, icon, and animations) */
    #ws-debug-panel,
    [id^="ws-debug-"],
    .ws-debug-icon,
    .websocket-debug,
    .websocket-plugin {
      display: none !important;
      visibility: hidden !important;
      pointer-events: none !important;
      opacity: 0 !important;
    }

    /* Base styles */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fefefe;
      background-image:
        radial-gradient(circle at 20% 10%, rgba(255, 182, 225, 0.08), transparent 25%),
        radial-gradient(circle at 80% 80%, rgba(255, 228, 155, 0.08), transparent 30%);
      background-attachment: fixed;
      overflow-x: hidden;
      width: 100%;
      color: #334155;
      --primary: #ec4899;
      --primary-light: #fce7f3;
      --primary-dark: #be185d;
      --secondary: #f97316;
      --secondary-light: #fff7ed;
      --gray-light: #f8fafc;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Modern, uniform transitions */
    .transition-all {
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Gradient text for branding */
    .gradient-text {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Primary button */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Secondary button */
    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 1px solid #f9d5e5;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Improved chat container */
    .chat-container {
      height: calc(100vh - 220px);
      min-height: 400px;
      scroll-behavior: smooth;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* Message bubbles */
    .message-bubble {
      position: relative;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      max-width: 85%;
      width: fit-content;
      word-break: break-word;
      box-shadow: var(--shadow-sm);
      line-height: 1.5;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      animation: fadeIn 0.3s ease forwards;
    }

    .message-bubble.sent {
      background-color: #fbdae8; /* Light pink for sent messages */
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }

    .message-bubble.received {
      background-color: #fff7da; /* Light yellow for received messages */
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }

    .message-bubble:hover {
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    /* Improved styling for images within message bubbles */
    .message-bubble img {
      display: block;
      max-width: 100%;
      margin: 8px 0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Improved styling for videos within message bubbles */
    .message-bubble video {
      display: block;
      max-width: 100%;
      margin: 8px 0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* User avatar */
    .avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s;
    }

    .avatar:hover {
      transform: scale(1.05);
    }

    .avatar-pink {
      background: linear-gradient(135deg, #ec4899, #f472b6);
    }

    .avatar-orange {
      background: linear-gradient(135deg, #f97316, #fb923c);
    }

    .avatar-blue {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .avatar-green {
      background: linear-gradient(135deg, #10b981, #34d399);
    }

    .avatar-purple {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    }

    .user-avatar {
      transition: all 0.3s ease;
      position: relative;
    }

    .user-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 10px rgba(236, 72, 153, 0.3);
    }

    .user-avatar.with-image {
      background-size: cover;
      background-position: center;
    }

    .user-avatar.with-image::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    /* Modern app header */
    .app-header {
      padding: 1rem;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* Mobile top bar */
    .mobile-top-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
    }

    /* User list item */
    .user-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s;
    }

    .user-item:hover {
      background-color: var(--gray-light);
    }

    /* Friend request button styling */
    .friend-btn {
      opacity: 0;
      transition: all 0.2s ease;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 6px;
      white-space: nowrap;
      margin-left: 4px;
    }

    .user-item:hover .friend-btn {
      opacity: 1;
    }

    .friend-btn-add {
      background-color: #fce7f3;
      color: #be185d;
    }

    .friend-btn-add:hover {
      background-color: #fbcfe8;
    }

    .friend-btn-pending {
      background-color: #e5e7eb;
      color: #6b7280;
      cursor: default;
    }

    .friend-btn-friends {
      background-color: #d1fae5;
      color: #047857;
      cursor: default;
    }

    /* Animation for request sent */
    @keyframes pulse-success {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .request-sent {
      animation: pulse-success 0.5s ease;
    }

    /* Sidebar section */
    .sidebar-section {
      background-color: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(236, 72, 153, 0.1);
    }

    .sidebar-section h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #374151;
    }

    /* Input area */
    .input-area {
      background-color: white;
      border-top: 1px solid rgba(236, 72, 153, 0.1);
      padding: 1rem;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .chat-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      background-color: var(--gray-light);
      transition: all 0.2s;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
      background-color: white;
      transform: translateY(-1px);
    }

    .chat-input:focus-visible {
      outline: 2px solid #ec4899;
      outline-offset: 2px;
    }

    /* Improved animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulseLight {
      0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.2); }
      70% { box-shadow: 0 0 0 6px rgba(236, 72, 153, 0); }
      100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
    }

    .message-bubble.new {
      animation: messageAppear 0.3s ease forwards;
    }

    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typing animation dots */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 1rem;
      width: fit-content;
      box-shadow: var(--shadow-sm);
      animation: fadeIn 0.3s ease;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-right: 0.5rem;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #ec4899;
      opacity: 0.6;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
    }

    /* Emoji panel */
    .emoji-panel {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: white;
      border-radius: 1rem;
      box-shadow: var(--shadow-md);
      padding: 0.75rem;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.375rem;
      margin-bottom: 0.5rem;
      z-index: 100;
      animation: fadeIn 0.2s ease;
      display: none;
    }

    .emoji-panel.show {
      display: grid;
    }

    .emoji-btn {
      width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background-color: var(--gray-light);
      transform: scale(1.1);
    }

    /* Emoji reactions */
    .emoji-reaction {
      transition: all 0.2s ease;
    }

    .emoji-reaction:hover {
      transform: scale(1.2);
    }

    .emoji-reaction.reacted {
      position: relative;
    }

    /* Reaction counter badge */
    .reaction-counter {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #fff;
      border-radius: 10px;
      padding: 0 4px;
      font-size: 10px;
      border: 1px solid #eee;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Tooltips */
    .tooltip {
      position: relative;
    }

    .tooltip:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.25rem 0.5rem;
      background-color: #334155;
      color: white;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      pointer-events: none;
      margin-bottom: 0.25rem;
    }

    .tooltip:hover:before {
      opacity: 1;
      visibility: visible;
    }

    /* Hide scrollbar but keep functionality */
    .hide-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    /* Jump to bottom button */
    .jump-to-bottom {
      position: absolute;
      bottom: 5rem;
      right: 1.25rem;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: white;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .jump-to-bottom.visible {
      opacity: 1;
      transform: scale(1);
    }

    .jump-to-bottom:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    /* New Message indicator */
    .new-message-indicator {
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: #ec4899;
      color: white;
      border-radius: 24px;
      padding: 8px 12px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .new-message-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .new-message-indicator:hover {
      background: #db2777;
    }

    /* Modal style */
    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal.open {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: white;
      border-radius: 1rem;
      width: 90%;
      max-width: 32rem;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes zoomIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Guest banner */
    .guest-banner {
      background: linear-gradient(135deg, rgba(255, 182, 225, 0.15), rgba(255, 228, 155, 0.15));
      border: 1px solid rgba(236, 72, 153, 0.2);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      animation: pulseLight 2s infinite;
    }

    /* Reactions styles */
    .reactions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }

    .reaction {
      background-color: white;
      border-radius: 1rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .reaction:hover {
      background-color: var(--gray-light);
      transform: scale(1.05);
    }

    /* Announcement styles */
    .announcement {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 0.75rem;
      margin-bottom: 0.75rem;
      animation: slideIn 0.5s ease;
      position: relative;
    }

    .announcement-content {
      padding: 0.75rem 1rem;
    }

    .dismiss-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .dismiss-btn:hover {
      background-color: #f3f4f6;
      transform: scale(1.1);
    }

    /* Clickable usernames */
    .username-link {
      transition: all 0.2s ease;
      position: relative;
    }

    .username-link:hover {
      color: #ec4899;
    }

    .username-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 1px;
      bottom: 0;
      left: 0;
      background-color: #ec4899;
      transition: width 0.3s ease;
    }

    .username-link:hover::after {
      width: 100%;
    }

    /* Username popover styling */
    #user-options-popover {
      min-width: 180px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      animation: popover-appear 0.2s ease;
    }

    @keyframes popover-appear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Badge for unread messages count */
    .unread-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0 4px;
    }

    /* Bookmark button */
    .bookmark-btn {
      transition: all 0.2s ease;
    }

    .bookmark-btn:hover {
      transform: scale(1.2);
    }

    .bookmark-btn.active {
      color: #ec4899;
      fill: #ec4899;
    }

    /* Notification toast */
    .notification-toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #ec4899, #f97316);
      color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      animation: toastIn 0.3s forwards, toastOut 0.3s forwards 3s;
    }

    @keyframes toastIn {
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      to { opacity: 0; transform: translateY(20px); }
    }

    /* Profile menu dropdown */
    .profile-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      width: 200px;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 0.5rem;
      z-index: 100;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .profile-menu.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .profile-menu-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: #4b5563;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
    }

    .profile-menu-item:hover {
      background-color: #f3f4f6;
      color: #ec4899;
    }

    .profile-menu-item svg {
      margin-right: 0.5rem;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .chat-container {
        height: calc(100vh - 200px);
      }

      .emoji-panel {
        right: 0;
        left: auto;
        width: 280px;
      }

      .message-bubble {
        max-width: 90%;
      }

      .user-list-item {
        display: inline-block;
        margin-right: 8px;
      }

      .user-list-item:after {
        content: ',';
      }

      .user-list-item:last-child:after {
        content: '';
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* Focus styles for keyboard navigation */
    a:focus-visible, button:focus-visible, input:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Profile Picture Modal Styles */
    .profile-pic-container {
      position: relative;
      overflow: hidden;
    }

    .profile-pic-container img {
      object-fit: cover;
      object-position: center;
    }

    .avatar-option {
      transition: all 0.2s ease;
    }

    .avatar-option:hover {
      transform: scale(1.05);
    }

    .avatar-option.selected {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <header class="app-header sm:hidden flex items-center justify-between">
    <a href="{% url 'index' %}" class="flex items-center" aria-label="Back to lobby">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </a>
    <h1 class="text-lg font-bold gradient-text">{{ room_name|title }}</h1>
    <button id="mobile-menu-toggle" class="relative" aria-label="Toggle user menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
      </svg>
      <!-- Added unread badge -->
      <span id="mobile-unread-badge" class="unread-badge hidden">0</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto p-4 sm:p-6">
    <!-- Desktop Header -->
    <div class="hidden sm:flex items-center justify-between mb-6">
      <div class="flex items-center">
        <h1 class="text-2xl font-bold gradient-text mr-2">{{ room_name|title }}</h1>
        <span class="px-2 py-0.5 text-xs bg-pink-100 text-pink-600 rounded-full font-medium">CHAT</span>
        {% if room.is_protected %}
        <span class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-600 rounded-full font-medium flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          PROTECTED
        </span>
        {% endif %}
        <button id="bookmark-room" class="tooltip ml-2 p-1.5 text-gray-400 hover:text-pink-500 rounded-full hover:bg-pink-50 bookmark-btn" data-tooltip="Bookmark room">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
          </svg>
        </button>
      </div>

      <div class="flex items-center gap-3">
        {% if user.is_authenticated %}
        <div id="user-profile-toggle" class="flex items-center bg-gray-50 hover:bg-gray-100 rounded-full px-3 py-1.5 cursor-pointer transition-all">
          <div class="avatar avatar-pink h-7 w-7 text-sm mr-2 user-avatar">
            {{ username|slice:":1"|upper }}
          </div>
          <span class="text-sm font-medium">{{ username }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        {% endif %}
        <a href="{% url 'index' %}" class="btn-secondary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          Lobby
        </a>
      </div>
    </div>

    <!-- Guest banner -->
    {% if not user.is_authenticated %}
    <div class="guest-banner mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <p class="text-pink-700 font-medium flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>You're in guest mode. Sign in to join the conversation!</span>
        </p>
        <div class="flex gap-2">
          <a href="{% url 'login' %}?next=/chat/{{ room_name }}/" class="btn-primary">Log in</a>
          <a href="{% url 'signup' %}" class="btn-secondary">Sign up</a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Announcements -->
    <div id="announcements-container" class="{% if active_announcements %}space-y-3 mb-6{% else %}hidden{% endif %}">
      {% for announcement in active_announcements %}
      <div class="announcement {% if announcement.is_read %}hidden{% endif %}" data-announcement-id="{{ announcement.id }}">
        <button class="dismiss-btn" aria-label="Dismiss announcement">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="announcement-content">
          <div class="flex items-start">
            <div class="flex-shrink-0 bg-blue-500 rounded-full p-2 mr-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-blue-800">Announcement from {{ announcement.creator }}</h3>
              <div class="text-gray-700 text-sm mt-1">{{ announcement.content|linebreaksbr }}</div>
              <div class="text-xs text-gray-500 mt-2">{{ announcement.created_at|date:"F j, Y, g:i a" }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- User List Panel - Mobile only, hidden by default -->
    <div id="mobile-user-list" class="sm:hidden bg-white p-4 rounded-xl shadow-md border border-pink-100 mb-4 hidden">
      <h3 class="text-base font-semibold text-gray-700 mb-2 flex items-center">
        <span class="h-2 w-2 bg-green-400 rounded-full mr-2"></span>
        Users in this room
      </h3>
      <div id="mobile-user-list-content" class="text-sm text-gray-600 flex flex-wrap gap-1"></div>
    </div>

    <!-- Chat Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Main Chat Area -->
      <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative h-full">
          <!-- Chat messages container -->
          <div id="chat-log" class="chat-container hide-scrollbar bg-gray-50">
            {% for message in messages %}
            <div class="flex items-start gap-2 group" data-message-id="{{ message.id }}">
              <!-- Avatar -->
              <div class="avatar avatar-{% if message.user.username == username %}pink{% else %}orange{% endif %} h-8 w-8 flex-shrink-0 text-sm user-avatar">
                {{ message.user.username|slice:":1"|upper }}
              </div>

              <!-- Message content -->
              <div class="flex-1">
                <div class="message-bubble {% if message.user.username == username %}sent{% else %}received{% endif %}">
                  <div class="flex items-start justify-between">
                    <a href="{% url 'direct_message' username=message.user.username %}" class="text-xs font-semibold mb-1 {% if message.user.username == username %}text-pink-500{% else %}text-yellow-600{% endif %} hover:underline username-link">
                      {{ message.user.username }}
                    </a>

                    <!-- Quick reaction buttons (desktop only) -->
                    <div class="ml-2 opacity-0 group-hover:opacity-100 sm:flex hidden">
                      <div class="flex space-x-1">
                        <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with heart">‚ù§Ô∏è</button>
                        <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with thumbs up">üëç</button>
                        <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with laugh">üòÇ</button>
                      </div>
                    </div>
                  </div>

                  <div class="text-sm text-gray-700 message-content">
                    {{ message.content|safe }}
                  </div>
                </div>

                <!-- Reactions -->
                <div class="reactions-container">
                  {% with reactions|default:"{}" as reaction_map %}
                    {% with reaction_map|dict_key:message.id as emoji_counts %}
                      {% for emoji, count in emoji_counts.items %}
                      <div class="reaction" data-emoji="{{ emoji }}">
                        {{ emoji }} <span class="reaction-count">{{ count }}</span>
                      </div>
                      {% endfor %}
                    {% endwith %}
                  {% endwith %}
                </div>
              </div>
            </div>
            {% endfor %}

            <!-- Typing indicator -->
            <div id="typing-indicator" class="hidden">
              <div class="typing-indicator">
                <div class="typing-dots">
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                </div>
                <span class="text-xs text-gray-500" id="typing-username">Someone is typing...</span>
              </div>
            </div>
          </div>

          <!-- File Preview Area -->
          <div id="preview" class="hidden p-3 border-t border-gray-100">
            <div class="relative bg-gray-50 p-2 rounded-lg border border-gray-200">
              <button id="cancel-preview" class="absolute -top-2 -right-2 bg-white text-red-500 rounded-full w-6 h-6 shadow hover:bg-red-50 flex items-center justify-center" aria-label="Cancel upload">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              <div id="preview-content" class="flex items-center gap-2 max-w-full overflow-x-auto hide-scrollbar pb-1"></div>
            </div>
          </div>

          <!-- Upload Progress -->
          <div id="progress-container" class="hidden px-4 py-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progress-bar" class="h-2 bg-gradient-to-r from-pink-500 to-orange-400 rounded-full w-0 transition-all"></div>
            </div>
          </div>

          <!-- Input Area -->
          <div class="input-area">
            <form id="message-form" class="flex gap-2 items-center">
              <!-- Emoji Button -->
              <div class="relative">
                <button id="emoji-button" type="button" class="p-2 text-xl hover:bg-gray-100 rounded-full transition-all tooltip" data-tooltip="Emojis" {% if not user.is_authenticated %}disabled style="opacity: 0.5; pointer-events: none;"{% endif %}>
                  <span aria-label="Emoji picker">üòä</span>
                </button>
                <div id="emoji-panel" class="emoji-panel">
                  <!-- Emojis grid -->
                  <div class="emoji-btn">üòä</div>
                  <div class="emoji-btn">üòÇ</div>
                  <div class="emoji-btn">‚ù§Ô∏è</div>
                  <div class="emoji-btn">üëç</div>
                  <div class="emoji-btn">üî•</div>
                  <div class="emoji-btn">‚ú®</div>
                  <div class="emoji-btn">üéâ</div>
                  <div class="emoji-btn">ü•∞</div>
                  <div class="emoji-btn">üòé</div>
                  <div class="emoji-btn">ü§î</div>
                  <div class="emoji-btn">üëÄ</div>
                  <div class="emoji-btn">üíØ</div>
                  <div class="emoji-btn">üôè</div>
                  <div class="emoji-btn">üí™</div>
                  <div class="emoji-btn">üåü</div>
                  <div class="emoji-btn">üíï</div>
                  <div class="emoji-btn">ü§©</div>
                  <div class="emoji-btn">üòç</div>
                  <div class="emoji-btn">ü•≥</div>
                  <div class="emoji-btn">üòÅ</div>
                </div>
              </div>

              <!-- Message Input -->
              <input
                id="chat-message-input"
                type="text"
                placeholder="{% if user.is_authenticated %}Type a message...{% else %}Log in to join the conversation{% endif %}"
                autocomplete="off"
                class="chat-input"
                {% if not user.is_authenticated %}disabled{% endif %}
                aria-label="Message input"
              />

              <!-- File Upload -->
              <label for="file-input" class="tooltip p-2.5 bg-yellow-100 text-yellow-600 rounded-full hover:bg-yellow-200 transition-all cursor-pointer flex items-center justify-center" data-tooltip="Attach files" {% if not user.is_authenticated %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
                <span class="sr-only">Attach files</span>
              </label>
              <input id="file-input" type="file" accept="image/*,video/*" class="hidden" multiple {% if not user.is_authenticated %}disabled{% endif %} />

              <!-- Send Button -->
              <button type="submit" id="send-btn" class="p-2.5 bg-gradient-to-r from-pink-500 to-orange-400 text-white rounded-full hover:shadow transition-all flex items-center justify-center tooltip" data-tooltip="Send" {% if not user.is_authenticated %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                <span class="sr-only">Send message</span>
              </button>
            </form>
          </div>

          <!-- Jump to bottom button -->
          <button id="jump-to-bottom" class="jump-to-bottom" aria-label="Jump to bottom">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Users list -->
        <div class="sidebar-section">
          <h3 class="flex items-center">
            <span class="h-2 w-2 bg-green-400 rounded-full mr-2"></span>
            Users in Room
          </h3>
          <ul id="user-list" class="space-y-1 max-h-48 overflow-y-auto hide-scrollbar">
            <!-- User list populated by JS -->
            <li class="user-item flex items-center justify-between animate-pulse">
              <div class="flex items-center gap-2">
                <div class="h-6 w-6 rounded-full bg-gray-200"></div>
                <div class="h-3 w-20 bg-gray-200 rounded"></div>
              </div>
            </li>
            <li class="user-item flex items-center justify-between animate-pulse">
              <div class="flex items-center gap-2">
                <div class="h-6 w-6 rounded-full bg-gray-200"></div>
                <div class="h-3 w-24 bg-gray-200 rounded"></div>
              </div>
            </li>
          </ul>
        </div>

        <!-- Recommended Rooms -->
        <div class="sidebar-section">
          <h3>Recommended Rooms</h3>
          <div id="recommended-rooms-list" class="space-y-2 text-sm">
            <div class="animate-pulse space-y-2">
              <div class="flex items-center gap-2">
                <div class="h-8 w-8 rounded-lg bg-gray-200"></div>
                <div class="flex-1 space-y-1">
                  <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                  <div class="h-2 bg-gray-200 rounded w-1/2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Friends Online -->
        <div class="sidebar-section">
          <h3>Friends Online</h3>
          <div id="online-friends-list" class="space-y-2 text-sm">
            <div class="animate-pulse space-y-2">
              <div class="flex items-center gap-2">
                <div class="h-8 w-8 rounded-full bg-gray-200"></div>
                <div class="flex-1 space-y-1">
                  <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                  <div class="h-2 bg-gray-200 rounded w-1/2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Feature Buttons -->
        <div class="grid grid-cols-2 gap-3">
          <button id="open-media-library" class="btn-secondary text-sm flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Media Library
          </button>

          <button id="open-whiteboard" class="btn-secondary text-sm flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            Whiteboard
          </button>

          <button id="create-meetup-btn" class="btn-secondary text-sm flex items-center justify-center col-span-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Plan a Meetup
          </button>
        </div>

        <!-- Room Controls -->
        <div class="sidebar-section">
          <h3>Room Controls</h3>
          <div class="flex flex-col gap-2">
            <a href="{% url 'index' %}" class="btn-secondary text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Back to Lobby
            </a>

            {% if user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="btn-secondary text-sm flex items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
              </button>
            </form>
            {% else %}
            <a href="{% url 'login' %}?next=/chat/{{ room_name }}/" class="btn-secondary text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Login
            </a>
            {% endif %}

            {% if can_delete and user.is_authenticated %}
            <form method="post" action="{% url 'delete_room' room_name %}">
              {% csrf_token %}
              <button type="submit" class="w-full bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-xl transition-all text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete Room
              </button>
            </form>
            {% endif %}

            {% if user.is_staff or user.username == room.creator.username %}
            <a href="{% url 'admin_room_detail' room_name=room_name %}" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-xl transition-all text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Admin Panel
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="py-4 border-t border-gray-100 mt-8 text-sm text-gray-500">
    <div class="max-w-4xl mx-auto px-4 flex flex-col sm:flex-row justify-between items-center">
      <div class="mb-3 sm:mb-0 text-center sm:text-left">
        <a href="{% url 'index' %}" class="flex items-center justify-center sm:justify-start">
            <h2 class="text-base font-bold gradient-text">Euphorie</h2>
            <span class="text-xs text-gray-400 ml-1">v1.2.0</span>
          </a>
          <p class="text-xs">¬© 2025 Euphorie. All rights reserved.</p>
        </div>
        <div class="flex items-center gap-6 text-xs">
          <a href="https://crene.com" target="_blank" rel="noopener" class="flex items-center gap-1.5 hover:text-indigo-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="hover:underline underline-offset-2">Crene.com</span>
          </a>
          <a href="https://diaryvault.com" target="_blank" rel="noopener" class="flex items-center gap-1.5 hover:text-green-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            <span class="hover:underline underline-offset-2">DiaryVault.com</span>
          </a>
        </div>
      </div>
    </footer>

    <!-- Modals -->
    <!-- Profile Menu -->
    <div id="profile-menu" class="hidden fixed right-4 top-16 bg-white rounded-xl shadow-md border border-gray-100 w-64 p-3 z-50">
      <div class="flex items-center p-2 border-b border-gray-100 mb-2">
        <div class="avatar avatar-pink h-10 w-10 mr-3">
          {{ username|slice:":1"|upper }}
        </div>
        <div>
          <p class="font-medium text-gray-800">{{ username }}</p>
          <p class="text-xs text-gray-500">{{ user.email }}</p>
        </div>
      </div>
      <div class="space-y-1">
        <a href="#" id="change-avatar-btn" class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="text-sm">Change Avatar</span>
        </a>
        <!-- Fix for user profile link error -->
        {% if user.is_authenticated %}
        <a href="{% url 'user_profile' username=username %}" class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="text-sm">Profile Settings</span>
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Media Library Modal -->
    <div id="media-library-modal" class="modal">
      <div class="modal-content w-full max-w-4xl p-4 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold gradient-text">Room Media Library</h2>
          <button id="close-media-library" class="text-gray-400 hover:text-red-400 text-xl transition-colors" aria-label="Close">√ó</button>
        </div>
        <div class="flex space-x-2 mb-4">
          <button class="media-filter-btn px-3 py-1 bg-pink-500 text-white rounded-lg text-sm font-medium" data-filter="all">All</button>
          <button class="media-filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" data-filter="images">Images</button>
          <button class="media-filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium" data-filter="videos">Videos</button>
        </div>
        <div class="flex-1 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 p-2" id="media-grid">
          <!-- Media items loaded by JS -->
        </div>
      </div>
    </div>

    <!-- Whiteboard Modal -->
    <div id="whiteboard-modal" class="modal">
      <div class="modal-content w-full max-w-4xl p-4 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold gradient-text">Collaborative Whiteboard</h2>
          <button id="close-whiteboard" class="text-gray-400 hover:text-red-400 text-xl transition-colors" aria-label="Close">√ó</button>
        </div>
        <div class="flex-1 bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
          <canvas id="whiteboard-canvas" class="w-full h-full"></canvas>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div class="flex items-center space-x-3">
            <input type="color" id="brush-color" value="#000000" class="w-10 h-10 rounded cursor-pointer">
            <select id="brush-size" class="rounded border border-gray-200 p-2 text-sm">
              <option value="2">Thin</option>
              <option value="5" selected>Medium</option>
              <option value="10">Thick</option>
            </select>
          </div>
          <button id="clear-whiteboard" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm">Clear All</button>
        </div>
      </div>
    </div>

    <!-- Meetup Modal -->
    <div id="meetup-modal" class="modal">
      <div class="modal-content max-w-md p-6">
        <h2 class="text-lg font-bold gradient-text mb-4">Plan a Meetup</h2>
        <form id="meetup-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="meetup-title">Meetup Title</label>
            <input type="text" id="meetup-title" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-pink-300 focus:border-pink-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="meetup-datetime">Date & Time</label>
            <input type="datetime-local" id="meetup-datetime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-pink-300 focus:border-pink-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="meetup-location">Location</label>
            <input type="text" id="meetup-location" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-pink-300 focus:border-pink-300" required placeholder="Enter address or place name">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="meetup-description">Description</label>
            <textarea id="meetup-description" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-pink-300 focus:border-pink-300 h-24" placeholder="What's this meetup about?"></textarea>
          </div>
          <div class="flex justify-end space-x-3 pt-2">
            <button type="button" id="cancel-meetup" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-all text-sm">Cancel</button>
            <button type="submit" class="btn-primary">Create Meetup</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Profile Picture Modal -->
    <div id="profile-pic-modal" class="modal">
      <div class="modal-content max-w-md p-6">
        <h2 class="text-lg font-bold gradient-text mb-4">Change Profile Picture</h2>
        <div class="flex items-center justify-center mb-6">
          <div id="profile-preview" class="avatar avatar-pink h-24 w-24 text-xl profile-pic-container">
            {{ username|slice:":1"|upper }}
          </div>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="profile-pic-upload">Upload Image</label>
            <input type="file" id="profile-pic-upload" accept="image/*" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-pink-300 focus:border-pink-300">
            <p class="text-xs text-gray-500 mt-1">Recommended: Square image, 500x500 pixels</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Choose Avatar Style</label>
            <div class="grid grid-cols-4 gap-2">
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-pink-400 to-orange-300 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-pink-400 to-orange-300">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-blue-400 to-indigo-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-blue-400 to-indigo-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-green-400 to-teal-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-green-400 to-teal-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-purple-400 to-pink-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-yellow-400 to-orange-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-red-400 to-pink-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-red-400 to-pink-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-cyan-400 to-blue-400 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-cyan-400 to-blue-400">
                {{ username|slice:":1"|upper }}
              </div>
              <div class="avatar-option h-16 w-16 rounded-full bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white text-xl cursor-pointer" data-gradient="from-emerald-400 to-green-500">
                {{ username|slice:":1"|upper }}
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 pt-2">
            <button type="button" id="cancel-profile-pic" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-all text-sm">Cancel</button>
            <button type="button" id="save-profile-pic" class="btn-primary">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Popover -->
    <div id="user-options-popover" class="hidden absolute bg-white rounded-lg shadow-xl border border-gray-100 p-2 z-50">
      <div class="space-y-1">
        <a href="#" class="flex items-center gap-2 px-3 py-2 hover:bg-pink-50 rounded-md transition-colors text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <span>Send Message</span>
        </a>
        <button class="w-full flex items-center gap-2 px-3 py-2 hover:bg-pink-50 rounded-md transition-colors text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
          <span>Add Friend</span>
        </button>
      </div>
    </div>

    <!-- Reaction User Modal -->
    <div id="reaction-modal" class="modal">
      <div class="modal-content max-w-xs p-4">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-bold gradient-text">People who reacted</h2>
          <button id="close-reaction-modal" class="text-gray-400 hover:text-red-400 text-xl transition-colors" aria-label="Close">√ó</button>
        </div>
        <ul id="reaction-user-list" class="text-sm text-gray-700 space-y-1 max-h-48 overflow-y-auto hide-scrollbar"></ul>
      </div>
    </div>

    <!-- Media Preview Modal -->
    <div id="media-preview-modal" class="modal">
      <div class="max-w-4xl max-h-screen p-4">
        <button id="close-media-preview" class="absolute top-4 right-4 text-white hover:text-pink-400 text-xl transition-colors z-50" aria-label="Close">√ó</button>
        <div id="media-preview-content" class="flex items-center justify-center"></div>
      </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed bottom-4 right-4 px-4 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-orange-400 text-white shadow-md z-50 transition-all transform translate-y-10 opacity-0">
      <span id="notification-message">Message sent successfully!</span>
    </div>

    <script>
      window.roomName = "{{ room_name|escapejs }}";
      window.username = "{{ username|escapejs }}";
    </script>

    <!-- WebSocket Connection Script - Added to fix connection issue -->
    <script>
      // Create the WebSocket connection as soon as the page loads
      document.addEventListener("DOMContentLoaded", function() {
        // Establish WebSocket connection
        const roomName = "{{ room_name|escapejs }}";
        const chatSocket = new WebSocket(
          'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
        );

        chatSocket.onopen = function(e) {
          console.log("WebSocket connection established");
        };

        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          console.log("Message received:", data);

          // Handle different message types
          if (data.type === 'chat_message') {
            addMessage(data.message, data.username, data.message_id);
          } else if (data.type === 'user_list') {
            updateUserList(data.users);
          } else if (data.type === 'typing') {
            showTypingIndicator(data.username);
          } else if (data.type === 'reaction') {
            updateReactions(data.message_id, data.emoji, data.count, data.username);
          }
        };

        chatSocket.onclose = function(e) {
          console.error("WebSocket connection closed unexpectedly");
          // Try to reconnect after a delay
          setTimeout(function() {
            console.log("Attempting to reconnect...");
            // Store this in window to make it accessible by other functions
            window.chatSocket = new WebSocket(
              'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
            );
          }, 3000);
        };

        chatSocket.onerror = function(e) {
          console.error("WebSocket error:", e);
        };

        // Store socket in global scope for other functions to use
        window.chatSocket = chatSocket;

        // Handle message sending
        const messageForm = document.getElementById('message-form');
        if (messageForm) {
          messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInput = document.getElementById('chat-message-input');
            const message = messageInput.value.trim();

            if (message) {
              chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
              }));
              messageInput.value = '';
            }
          });
        }
      });

      // Simple function to add a message to the chat log
      // This will be called when a message is received via WebSocket
      window.addMessage = function(message, username, messageId) {
        const chatLog = document.getElementById('chat-log');
        if (!chatLog) return;

        const isCurrentUser = username === window.username;

        const messageElement = document.createElement('div');
        messageElement.className = 'flex items-start gap-2 group';
        messageElement.setAttribute('data-message-id', messageId);

        // Create avatar
        const avatarElement = document.createElement('div');
        avatarElement.className = `avatar avatar-${isCurrentUser ? 'pink' : 'orange'} h-8 w-8 flex-shrink-0 text-sm user-avatar`;
        avatarElement.textContent = username.slice(0, 1).toUpperCase();

        // Create message content container
        const contentContainer = document.createElement('div');
        contentContainer.className = 'flex-1';

        // Create message bubble
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isCurrentUser ? 'sent' : 'received'} new`;

        // Create header with username
        const header = document.createElement('div');
        header.className = 'flex items-start justify-between';

        const usernameLink = document.createElement('a');
        usernameLink.href = `/dm/${username}/`;
        usernameLink.className = `text-xs font-semibold mb-1 ${isCurrentUser ? 'text-pink-500' : 'text-yellow-600'} hover:underline username-link`;
        usernameLink.textContent = username;

        header.appendChild(usernameLink);

        // Quick reactions (only visible on hover/desktop)
        const reactionsContainer = document.createElement('div');
        reactionsContainer.className = 'ml-2 opacity-0 group-hover:opacity-100 sm:flex hidden';
        reactionsContainer.innerHTML = `
          <div class="flex space-x-1">
            <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with heart">‚ù§Ô∏è</button>
            <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with thumbs up">üëç</button>
            <button class="emoji-reaction p-1 text-xs bg-white rounded-full shadow-sm hover:bg-pink-50" aria-label="React with laugh">üòÇ</button>
          </div>
        `;

        header.appendChild(reactionsContainer);
        bubble.appendChild(header);

        // Message content
        const messageContent = document.createElement('div');
        messageContent.className = 'text-sm text-gray-700 message-content';
        messageContent.innerHTML = message;
        bubble.appendChild(messageContent);

        contentContainer.appendChild(bubble);

        // Area for reaction emojis display
        const reactionsDisplayArea = document.createElement('div');
        reactionsDisplayArea.className = 'reactions-container';
        contentContainer.appendChild(reactionsDisplayArea);

        // Assemble the message
        messageElement.appendChild(avatarElement);
        messageElement.appendChild(contentContainer);

        chatLog.appendChild(messageElement);

        // Scroll to the bottom to show the new message
        chatLog.scrollTop = chatLog.scrollHeight;

        // Set up reaction emojis
        const emojiButtons = messageElement.querySelectorAll('.emoji-reaction');
        emojiButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const emoji = this.textContent;
            if (window.chatSocket && window.chatSocket.readyState === WebSocket.OPEN) {
              window.chatSocket.send(JSON.stringify({
                'type': 'reaction',
                'message_id': messageId,
                'emoji': emoji
              }));
            }
          });
        });
      };

      // Function to show typing indicator
      window.showTypingIndicator = function(username) {
        const typingIndicator = document.getElementById('typing-indicator');
        const typingUsername = document.getElementById('typing-username');

        if (typingIndicator && typingUsername) {
          // Don't show if it's the current user typing
          if (username === window.username) return;

          typingUsername.textContent = `${username} is typing...`;
          typingIndicator.classList.remove('hidden');

          // Hide after 3 seconds if no new typing events
          clearTimeout(window.typingTimeout);
          window.typingTimeout = setTimeout(function() {
            typingIndicator.classList.add('hidden');
          }, 3000);
        }
      };

      // Function to update the user list
      window.updateUserList = function(users) {
        const userList = document.getElementById('user-list');
        const mobileUserList = document.getElementById('mobile-user-list-content');

        if (!userList && !mobileUserList) return;

        if (userList) {
          userList.innerHTML = '';

          users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item flex items-center justify-between';

            const nameContainer = document.createElement('div');
            nameContainer.className = 'flex items-center';

            const avatar = document.createElement('div');
            avatar.className = `h-6 w-6 rounded-full ${user.is_online ? 'bg-green-400' : 'bg-gray-300'} text-white flex items-center justify-center text-xs mr-2`;
            avatar.textContent = user.username.slice(0, 1).toUpperCase();

            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-sm';
            nameSpan.textContent = user.username;

            nameContainer.appendChild(avatar);
            nameContainer.appendChild(nameSpan);
            li.appendChild(nameContainer);

            userList.appendChild(li);
          });
        }

        if (mobileUserList) {
          mobileUserList.innerHTML = '';

          users.forEach(user => {
            const span = document.createElement('span');
            span.className = 'user-list-item px-2 py-1 bg-gray-100 rounded-full mr-1 mb-1 text-xs';
            span.textContent = user.username;
            mobileUserList.appendChild(span);
          });
        }
      };

      // Function to update reactions on a message
      window.updateReactions = function(messageId, emoji, count, username) {
        const message = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!message) return;

        const reactionsContainer = message.querySelector('.reactions-container');
        if (!reactionsContainer) return;

        // Check if the reaction already exists
        let reactionElement = reactionsContainer.querySelector(`[data-emoji="${emoji}"]`);

        if (count <= 0) {
          // Remove the reaction if count is 0
          if (reactionElement) {
            reactionElement.remove();
          }
          return;
        }

        if (!reactionElement) {
          // Create new reaction element
          reactionElement = document.createElement('div');
          reactionElement.className = 'reaction';
          reactionElement.setAttribute('data-emoji', emoji);
          reactionElement.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;

          // Add click handler to show who reacted
          reactionElement.addEventListener('click', function() {
            // Implement showing reaction users here
            showReactionUsers(messageId, emoji);
          });

          reactionsContainer.appendChild(reactionElement);
        } else {
          // Update existing reaction count
          const countElement = reactionElement.querySelector('.reaction-count');
          if (countElement) {
            countElement.textContent = count;
          }
        }
      };

      // Function to show who reacted
      function showReactionUsers(messageId, emoji) {
        // This would typically fetch the users from the server
        // For demo, we'll just show a placeholder
        const reactionModal = document.getElementById('reaction-modal');
        const reactionUserList = document.getElementById('reaction-user-list');

        if (reactionModal && reactionUserList) {
          reactionUserList.innerHTML = `<li>Loading users who reacted with ${emoji}...</li>`;
          reactionModal.classList.add('open');

          // In a real implementation, you would fetch the users who reacted
          // from the server here and update the list
        }
      }
    </script>

    <script src="{% static 'js/chatroom.js' %}?t={{ timestamp|default:1683021549 }}" defer></script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Make room name at the top direct to index.html
        document.querySelectorAll('.gradient-text').forEach(element => {
          if (element.textContent.includes("{{ room_name|title }}")) {
            const parentElement = element.closest('a') || element.parentElement;
            if (parentElement) {
              parentElement.href = "{% url 'index' %}";
            } else {
              // Create a wrapper link if none exists
              const wrapper = document.createElement('a');
              wrapper.href = "{% url 'index' %}";
              wrapper.style.cursor = 'pointer';
              element.parentNode.insertBefore(wrapper, element);
              wrapper.appendChild(element);
            }
          }
        });

        // Initialize variables
        const chatLog = document.getElementById('chat-log');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('chat-message-input');
        const jumpToBottomBtn = document.getElementById('jump-to-bottom');
        const userProfileToggle = document.getElementById('user-profile-toggle');
        const profileMenu = document.getElementById('profile-menu');
        const modals = document.querySelectorAll('.modal');

        // Show/hide jump to bottom button based on scroll position
        if (chatLog) {
          chatLog.addEventListener('scroll', function() {
            const scrollBottom = this.scrollHeight - this.scrollTop - this.clientHeight;
            if (scrollBottom > 100) {
              jumpToBottomBtn.classList.add('visible');
            } else {
              jumpToBottomBtn.classList.remove('visible');
            }
          });

          // Initial scroll to bottom
          scrollToBottom(true);
        }

        // Jump to bottom button functionality
        if (jumpToBottomBtn) {
          jumpToBottomBtn.addEventListener('click', function() {
            scrollToBottom(true);
          });
        }

        // Fix dropdown menu position - Toggle profile menu
        if (userProfileToggle && profileMenu) {
          userProfileToggle.addEventListener('click', function(e) {
            e.stopPropagation();

            // Position the menu properly
            const rect = userProfileToggle.getBoundingClientRect();
            profileMenu.style.top = (rect.bottom + window.scrollY) + 'px';
            profileMenu.style.right = (window.innerWidth - rect.right) + 'px';
            profileMenu.style.left = 'auto'; // Clear any left positioning

            profileMenu.classList.toggle('hidden');
          });

          // Close when clicking elsewhere
          document.addEventListener('click', function(e) {
            if (!userProfileToggle.contains(e.target) && !profileMenu.contains(e.target)) {
              profileMenu.classList.add('hidden');
            }
          });
        }

        // Initialize emoji picker
        const emojiButton = document.getElementById('emoji-button');
        const emojiPanel = document.getElementById('emoji-panel');

        if (emojiButton && emojiPanel) {
          emojiButton.addEventListener('click', function(e) {
            e.stopPropagation();
            emojiPanel.classList.toggle('show');
          });

          // Close emoji panel when clicking outside
          document.addEventListener('click', function(e) {
            if (!emojiButton.contains(e.target) && !emojiPanel.contains(e.target)) {
              emojiPanel.classList.remove('show');
            }
          });

          // Add emoji to message input when clicked
          const emojiButtons = document.querySelectorAll('.emoji-btn');
          emojiButtons.forEach(btn => {
            btn.addEventListener('click', function() {
              if (messageInput) {
                messageInput.value += this.textContent;
                messageInput.focus();
                emojiPanel.classList.remove('show');
              }
            });
          });
        }

        // Modal handling
        document.querySelectorAll('[id$="-modal"]').forEach(modal => {
          const closeBtn = modal.querySelector('[id^="close-"]');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              modal.classList.remove('open');
            });
          }
        });

        // Open modal functions
        const mediaLibraryBtn = document.getElementById('open-media-library');
        const mediaLibraryModal = document.getElementById('media-library-modal');
        if (mediaLibraryBtn && mediaLibraryModal) {
          mediaLibraryBtn.addEventListener('click', () => {
            mediaLibraryModal.classList.add('open');
          });
        }

        const whiteboardBtn = document.getElementById('open-whiteboard');
        const whiteboardModal = document.getElementById('whiteboard-modal');
        if (whiteboardBtn && whiteboardModal) {
          whiteboardBtn.addEventListener('click', () => {
            whiteboardModal.classList.add('open');
          });
        }

        const meetupBtn = document.getElementById('create-meetup-btn');
        const meetupModal = document.getElementById('meetup-modal');
        if (meetupBtn && meetupModal) {
          meetupBtn.addEventListener('click', () => {
            meetupModal.classList.add('open');
          });
        }

        const cancelMeetupBtn = document.getElementById('cancel-meetup');
        if (cancelMeetupBtn && meetupModal) {
          cancelMeetupBtn.addEventListener('click', () => {
            meetupModal.classList.remove('open');
          });
        }

        // Avatar change modal
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const profilePicModal = document.getElementById('profile-pic-modal');
        const cancelProfilePicBtn = document.getElementById('cancel-profile-pic');

        if (changeAvatarBtn && profilePicModal) {
          changeAvatarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (profileMenu) profileMenu.classList.add('hidden');
            profilePicModal.classList.add('open');
          });
        }

        if (cancelProfilePicBtn && profilePicModal) {
          cancelProfilePicBtn.addEventListener('click', () => {
            profilePicModal.classList.remove('open');
          });
        }

        // Avatar option selection
        document.querySelectorAll('.avatar-option').forEach(option => {
          option.addEventListener('click', function() {
            document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');

            // Update the preview
            const gradient = this.getAttribute('data-gradient');
            const profilePreview = document.getElementById('profile-preview');
            if (profilePreview) {
              profilePreview.className = 'avatar h-24 w-24 text-xl profile-pic-container';
              profilePreview.classList.add('bg-gradient-to-br', ...gradient.split(' '));
            }
          });
        });

        // Save avatar changes
        const saveProfilePicBtn = document.getElementById('save-profile-pic');
        if (saveProfilePicBtn) {
          saveProfilePicBtn.addEventListener('click', () => {
            // Here you would handle the actual saving of the avatar
            // Then show a notification and close the modal
            showNotification('Profile picture updated successfully');
            profilePicModal.classList.remove('open');
          });
        }

        // Initialize mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        if (mobileMenuToggle) {
          mobileMenuToggle.addEventListener('click', function() {
            // Toggle mobile user list
            const mobileUserList = document.getElementById('mobile-user-list');
            if (mobileUserList) {
              mobileUserList.classList.toggle('hidden');
            }
          });
        }

        // Initialize bookmark functionality
        initializeBookmarkButton();

        // Helper function to scroll to bottom of chat
        function scrollToBottom(instant) {
          if (!chatLog) return;

          if (instant) {
            chatLog.style.scrollBehavior = 'auto';
            chatLog.scrollTop = chatLog.scrollHeight;
            setTimeout(() => {
              chatLog.style.scrollBehavior = 'smooth';
            }, 100);
          } else {
            chatLog.scrollTop = chatLog.scrollHeight;
          }
        }

        // Show notification function
        window.showNotification = function(message) {
          const toast = document.getElementById('notification-toast');
          const messageEl = document.getElementById('notification-message');

          if (toast && messageEl) {
            messageEl.textContent = message;
            toast.classList.remove('translate-y-10', 'opacity-0');

            setTimeout(() => {
              toast.classList.add('translate-y-10', 'opacity-0');
            }, 3000);
          }
        };

        // Initialize bookmark button
        function initializeBookmarkButton() {
          const bookmarkBtn = document.getElementById('bookmark-room');
          if (!bookmarkBtn) return;

          // Check if room is already bookmarked
          const isBookmarked = localStorage.getItem(`bookmarked_${window.roomName}`) === 'true';
          updateBookmarkButton(isBookmarked);

          // Add click event
          bookmarkBtn.addEventListener('click', function() {
            const newState = localStorage.getItem(`bookmarked_${window.roomName}`) === 'true' ? false : true;

            // Get CSRF token and send request to server
            const csrfToken = getCsrfToken();
            fetch('/api/toggle_bookmark_room/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              },
              body: JSON.stringify({
                room_name: window.roomName,
                bookmarked: newState
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                localStorage.setItem(`bookmarked_${window.roomName}`, newState);
                updateBookmarkButton(newState);
                showNotification(newState ? 'Room bookmarked!' : 'Bookmark removed');
              } else {
                showNotification('Failed to update bookmark');
              }
            })
            .catch(error => {
              console.error('Error toggling bookmark:', error);
              showNotification('An error occurred');
            });
          });
        }

        // Helper function to update bookmark button appearance
        function updateBookmarkButton(isBookmarked) {
          const bookmarkBtn = document.getElementById('bookmark-room');
          if (!bookmarkBtn) return;

          if (isBookmarked) {
            bookmarkBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
              </svg>
            `;
            bookmarkBtn.classList.add('text-pink-500');
            bookmarkBtn.setAttribute('data-tooltip', 'Remove bookmark');
          } else {
            bookmarkBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
              </svg>
            `;
            bookmarkBtn.classList.remove('text-pink-500');
            bookmarkBtn.setAttribute('data-tooltip', 'Bookmark room');
          }
        }

        // Helper function to get CSRF token
        function getCsrfToken() {
          const name = 'csrftoken=';
          const decodedCookie = decodeURIComponent(document.cookie);
          const cookieArray = decodedCookie.split(';');

          for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
              return cookie.substring(name.length, cookie.length);
            }
          }

          const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
          return csrfInput ? csrfInput.value : '';
        }

        // Enhanced message handling
        if (typeof window.addMessage === 'function') {
          const originalAddMessage = window.addMessage;
          window.addMessage = function(message, username, messageId) {
            originalAddMessage.call(this, message, username, messageId);

            const chatLog = document.getElementById('chat-log');
            if (!chatLog) return;

            const scrollBottom = chatLog.scrollHeight - chatLog.scrollTop - chatLog.clientHeight;

            // If user is scrolled up, show indicator
            if (scrollBottom > 100) {
              jumpToBottomBtn.classList.add('visible');
            } else {
              // User is at bottom, auto-scroll
              scrollToBottom(false);
            }
          };
        }

        // Close announcement banners
        document.querySelectorAll('.dismiss-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const announcement = this.closest('.announcement');
            if (announcement) {
              announcement.classList.add('hidden');

              // If you want to mark it as read on the server
              const announcementId = announcement.getAttribute('data-announcement-id');
              if (announcementId) {
                const csrfToken = getCsrfToken();
                fetch('/api/mark_announcement_read/', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                  },
                  body: JSON.stringify({
                    announcement_id: announcementId
                  })
                });
              }
            }
          });
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Enhance username links throughout the chat
        enhanceUsernameLinks();

        // Store reference to the original updateUserList function
        const originalUpdateUserList = window.updateUserList || function() {};

        // Replace with enhanced version that adds friend request buttons
        window.updateUserList = function(users) {
          // First call the original function
          originalUpdateUserList.call(this, users);

          // Then enhance the user list with friend buttons
          const userList = document.getElementById("user-list");
          if (!userList) return;

          // Get all user list items
          const listItems = userList.querySelectorAll('li');

          // Process each list item
          listItems.forEach(li => {
            // Add user-item class for hover effects
            li.classList.add('user-item');

            // Get the username
            const nameSpan = li.querySelector('span');
            if (!nameSpan) return;

            const username = nameSpan.textContent;

            // Skip if it's the current user
            if (username === window.username) return;

            // Skip if already has a friend button
            if (li.querySelector('.friend-btn')) return;

            // Get the actions container or create one if it doesn't exist
            let actionsContainer = li.querySelector('div:last-child');
            if (!actionsContainer) {
              actionsContainer = document.createElement('div');
              actionsContainer.className = 'flex items-center';
              li.appendChild(actionsContainer);
            }

            // Create Add Friend button
            const friendBtn = document.createElement('button');
            friendBtn.className = 'friend-btn friend-btn-add';
            friendBtn.textContent = 'Add Friend';
            friendBtn.onclick = () => sendFriendRequest(username);

            // Insert before any existing actions
            actionsContainer.insertBefore(friendBtn, actionsContainer.firstChild);
          });
        };

        // Enhance all username links in the chat with popover menu
        function enhanceUsernameLinks() {
          // Find all username links and enhance them
          document.addEventListener('click', function(e) {
            // Check if clicked element is a username link
            if (e.target.classList.contains('username-link') ||
                e.target.parentElement.classList.contains('username-link')) {
              e.preventDefault(); // Prevent default navigation

              // Get the username
              const link = e.target.classList.contains('username-link') ?
                          e.target : e.target.parentElement;
              const username = link.textContent.trim();

              // Skip if it's the current user
              if (username === window.username) return;

              // Create or show popover menu
              showUserOptions(link, username);
            }
          });
        }

        // Show user interaction options popover
        function showUserOptions(element, username) {
          // Remove any existing popovers
          const existingPopover = document.getElementById('user-options-popover');
          if (existingPopover) {
            existingPopover.remove();
          }

          // Create popover element
          const popover = document.createElement('div');
          popover.id = 'user-options-popover';
          popover.className = 'bg-white rounded-lg shadow-xl border border-gray-200 p-2 absolute z-50';

          // Set position near the username
          const rect = element.getBoundingClientRect();
          popover.style.top = (rect.bottom + window.scrollY + 5) + 'px';
          popover.style.left = (rect.left + window.scrollX) + 'px';

          // Add options
          const optionsList = document.createElement('div');
          optionsList.className = 'space-y-1';

          // DM option
          const dmOption = document.createElement('a');
          dmOption.href = `/dm/${username}/`;
          dmOption.className = 'flex items-center gap-2 px-3 py-2 hover:bg-pink-50 rounded-md transition-colors';
          dmOption.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <span class="text-sm text-gray-700">Send Message</span>
          `;

          // Add Friend option
          const friendOption = document.createElement('button');
          friendOption.className = 'w-full flex items-center gap-2 px-3 py-2 hover:bg-pink-50 rounded-md transition-colors';
          friendOption.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            <span class="text-sm text-gray-700">Add Friend</span>
          `;
          friendOption.onclick = function() {
            sendFriendRequest(username);
            popover.remove();
          };

          // Add options to list
          optionsList.appendChild(dmOption);
          optionsList.appendChild(friendOption);
          popover.appendChild(optionsList);

          // Add to page
          document.body.appendChild(popover);

          // Close when clicking outside
          document.addEventListener('click', function closePopover(e) {
            if (!popover.contains(e.target) && e.target !== element) {
              popover.remove();
              document.removeEventListener('click', closePopover);
            }
          });
        }

        // Function to send friend request
        window.sendFriendRequest = function(otherUser) {
          // Get CSRF token
          const csrfToken = getCsrfToken();

          fetch('/api/friend_request/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              receiver_id: otherUser  // This matches your API expectation
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification(`Friend request sent to ${otherUser}`);

              // Find and update any friend buttons for this user
              document.querySelectorAll('.friend-btn').forEach(btn => {
                if (btn.parentElement.previousElementSibling &&
                    btn.parentElement.previousElementSibling.querySelector('span') &&
                    btn.parentElement.previousElementSibling.querySelector('span').textContent === otherUser) {
                  btn.className = 'friend-btn friend-btn-pending request-sent';
                  btn.textContent = 'Pending';
                  btn.onclick = null;
                }
              });
            } else {
              showNotification('Failed to send friend request: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error sending friend request:', error);
            showNotification('An error occurred while sending friend request');
          });
        };

        // Helper function for CSRF token
        function getCsrfToken() {
          const name = 'csrftoken=';
          const decodedCookie = decodeURIComponent(document.cookie);
          const cookieArray = decodedCookie.split(';');

          for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
              return cookie.substring(name.length, cookie.length);
            }
          }

          // If not found in cookies, try to find it in a meta tag
          const csrfMeta = document.querySelector('meta[name="csrf-token"]');
          if (csrfMeta) {
            return csrfMeta.getAttribute('content');
          }

          // Last resort - look for hidden input field
          const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
          if (csrfInput) {
            return csrfInput.value;
          }

          return '';
        }
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Profile dropdown functionality
          const profileToggle = document.getElementById('user-profile-toggle');
          const profileMenu = document.getElementById('profile-menu');
          const changeAvatarBtn = document.getElementById('change-avatar-btn');
          const profilePicModal = document.getElementById('profile-pic-modal');

          if (profileToggle && profileMenu) {
              profileToggle.addEventListener('click', function() {
                  profileMenu.classList.toggle('open');
              });

              // Close when clicking elsewhere
              document.addEventListener('click', function(e) {
                  if (!profileToggle.contains(e.target) && !profileMenu.contains(e.target)) {
                      profileMenu.classList.remove('open');
                  }
              });
          }

          // Open profile picture modal from dropdown
          if (changeAvatarBtn && profilePicModal) {
              changeAvatarBtn.addEventListener('click', function(e) {
                  e.preventDefault();
                  profileMenu.classList.remove('open');
                  profilePicModal.classList.add('flex');
                  profilePicModal.classList.remove('hidden');
              });
          }
      });
    </script>

    <script>
    //File Upload error fix
    async function uploadFilesAndSend(files) {
        const formData = new FormData();

        // Add files to the form data
        for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
        }

        // Add room name to the form data
        formData.append('room_name', window.roomName);

        // Add CSRF token (crucial for Django)
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        try {
        // Show progress indicator
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        progressContainer.classList.remove('hidden');

        // Use XMLHttpRequest for upload progress
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
            }
            });

            xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                progressContainer.classList.add('hidden');

                if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                    resolve(data.file_urls);
                    } else {
                    reject(new Error(data.error || 'Unknown error'));
                    }
                } catch (e) {
                    reject(new Error('Invalid response from server'));
                }
                } else {
                reject(new Error('Server responded with status: ' + xhr.status));
                }
            }
            };

            xhr.open('POST', '/api/upload_media/', true);
            xhr.send(formData);
        });
        } catch (error) {
        console.error('Error uploading files:', error);
        throw error;
        }
    }
    </script>
  </body>
  </html>
